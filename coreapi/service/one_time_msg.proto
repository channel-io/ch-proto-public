syntax = "proto3";

package coreapi.service;

import "buf/validate/validate.proto";
import "coreapi/common/sort_order.proto";
import "coreapi/model/one_time_msg.proto";
import "coreapi/model/one_time_msg_user.proto";

option go_package = "github.com/channel-io/ch-proto-public/coreapi/go/service";
option java_multiple_files = true;
option java_package = "io.channel.api.proto.pub.coreapi.service";

// Retrieves a list of one-time messages.
//
// The number of one-time messages retrieved is restricted by the limit parameter,
// and is capped to values in the closed interval [1, 500].
// Pagination is cursor-based. Pass the nextCursor value from the previous response
// as the cursor parameter to retrieve the next page.
// If the cursor parameter is left empty, the list starts with the
// first one-time message in descending order of updatedAt.
//
// The states parameter filters by one-time message lifecycle state.
// If left empty, all one-time messages are returned regardless of state.
message SearchOneTimeMsgsRequest {
  // Channel ID to search one-time messages in.
  string channel_id = 1 [(buf.validate.field).required = true];

  // Opaque pagination cursor from a previous response.
  string cursor = 2;

  // Maximum number of results to return. Defaults to 25 if unset.
  int32 limit = 3 [(buf.validate.field).cel = {
    id: "int32.between"
    message: "limit must be between 1 and 500"
    expression: "this == 0 || (this >= 1 && this <= 500)"
  }];

  // Filter by one-time message lifecycle states.
  // If empty, all states are included.
  repeated coreapi.model.OneTimeMsgState states = 4;
}

// Response for one-time message list retrieval.
message SearchOneTimeMsgsResult {
  repeated coreapi.model.OneTimeMsg one_time_msgs = 1;

  // Opaque cursor for the next page. Null if no more results.
  string next_cursor = 2;

  // Whether more results are available beyond this page.
  bool has_more = 3;
}

// Retrieves a single one-time message.
message GetOneTimeMsgRequest {
  // One-time message ID to retrieve.
  string id = 1 [(buf.validate.field).required = true];

  // Channel ID the one-time message belongs to.
  string channel_id = 2 [(buf.validate.field).required = true];
}

// Response for single one-time message retrieval.
message GetOneTimeMsgResult {
  coreapi.model.OneTimeMsg one_time_msg = 1;
}

// Retrieves a list of users who received a one-time message.
//
// The number of users retrieved is restricted by the limit parameter,
// and is capped to values in the closed interval [1, 500].
// Pagination is cursor-based. Pass the nextCursor value from the previous response
// as the cursor parameter to retrieve the next page.
// If the cursor parameter is left empty, the list starts with the
// first user ordered by the specified state and sort order.
//
// The state parameter determines which interaction metric is used for
// sorting and filtering. Must be one of: sent, view, goal, click.
//
// Users updated more than a year ago are not retrieved.
//
// The one-time message user is not a target of the unify process.
// The data would not be unified even if the user logs in afterwards.
message SearchOneTimeMsgUsersRequest {
  // Channel ID the one-time message belongs to.
  string channel_id = 1 [(buf.validate.field).required = true];

  // One-time message ID to retrieve users for.
  string one_time_msg_id = 2 [(buf.validate.field).required = true];

  // Interaction state to filter and sort users by.
  coreapi.model.OneTimeMsgUserState state = 3 [(buf.validate.field).required = true];

  // Opaque pagination cursor from a previous response.
  string cursor = 4;

  // Maximum number of results to return. Defaults to 25 if unset.
  int32 limit = 5 [(buf.validate.field).cel = {
    id: "int32.between"
    message: "limit must be between 1 and 500"
    expression: "this == 0 || (this >= 1 && this <= 500)"
  }];

  // Sort order for results. Defaults to descending if unset.
  coreapi.common.SortOrder sort_order = 6;
}

// Response for one-time message user list retrieval.
message SearchOneTimeMsgUsersResult {
  repeated coreapi.model.OneTimeMsgUser one_time_msg_users = 1;

  // Opaque cursor for the next page. Null if no more results.
  string next_cursor = 2;

  // Whether more results are available beyond this page.
  bool has_more = 3;
}

// Retrieves a single one-time message user by oneTimeMsgId and userId.
message GetOneTimeMsgUserRequest {
  // One-time message ID the user record belongs to.
  string one_time_msg_id = 1 [(buf.validate.field).required = true];

  // User ID to retrieve.
  string user_id = 2 [(buf.validate.field).required = true];

  // Channel ID the one-time message belongs to.
  string channel_id = 3 [(buf.validate.field).required = true];
}

// Response for single one-time message user retrieval.
message GetOneTimeMsgUserResult {
  coreapi.model.OneTimeMsgUser one_time_msg_user = 1;
}
